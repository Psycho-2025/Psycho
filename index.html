<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Psycho Messenger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Base Styles */
    html, body {
      height: 100%;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Fix for Chinese OEM browsers */
    @supports (-webkit-touch-callout: none) {
      body {
        height: -webkit-fill-available;
      }
    }

    .online-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .online {
      background-color: #10B981;
    }
    .offline {
      background-color: #EF4444;
    }
    .typing-indicator {
      opacity: 0.6;
      font-size: 0.8rem;
      margin-left: 10px;
      font-style: italic;
    }
    
    /* Responsive Message Container */
    .message-container {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Responsive Message Bubbles */
    .message-bubble {
      max-width: 85%;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      word-break: break-word;
    }
    .sent {
      background-color: #3B82F6;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }
    .received {
      background-color: #E5E7EB;
      color: #111827;
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
    }
    
    /* Mobile-First Layout */
    #chatInterface {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
    }
    
    .sidebar {
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      border-right: none;
      border-bottom: 1px solid #E5E7EB;
    }
    
    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* Tablet Layout */
    @media (min-width: 640px) {
      .message-bubble {
        max-width: 70%;
      }
    }
    
    /* Desktop Layout */
    @media (min-width: 768px) {
      #chatInterface {
        flex-direction: row;
        height: calc(100vh - 60px);
      }
      
      .sidebar {
        width: 250px;
        max-height: none;
        border-right: 1px solid #E5E7EB;
        border-bottom: none;
      }
      
      .message-container {
        max-height: calc(100vh - 160px);
      }
    }
    
    /* Large Desktop */
    @media (min-width: 1024px) {
      .sidebar {
        width: 300px;
      }
    }
    
    /* Touch Targets */
    button, [role="button"], input[type="submit"] {
      min-width: 44px;
      min-height: 44px;
    }
    
    /* iOS Input Zoom Fix */
    @media screen and (-webkit-min-device-pixel-ratio:0) {
      input, textarea {
        font-size: 16px;
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto max-w-6xl h-full flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">Psycho Messenger</h1>
        <div id="userInfo" class="hidden">
          <span id="currentUserName" class="font-medium"></span>
          <button id="logoutBtn" class="ml-4 px-3 py-1 bg-white text-blue-600 rounded-md text-sm">Logout</button>
        </div>
      </div>
    </header>

    <!-- Login Form -->
    <div id="loginForm" class="max-w-md mx-auto my-auto bg-white p-8 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Login to Psycho</h2>
      
      <div class="mb-4">
        <label for="userSelect" class="block text-sm font-medium text-gray-700 mb-1">Who are you?</label>
        <select id="userSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          <option value="">Select your name</option>
          <option value="Abdullah">Abdullah</option>
          <option value="Noman">Noman</option>
          <option value="Prottoy">Prottoy</option>
          <option value="Raisul">Raisul</option>
          <option value="Yusha">Yusha</option>
          <option value="Admin">Admin</option>
        </select>
      </div>

      <div class="mb-6">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md"/>
      </div>

      <button id="loginBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Login</button>
    </div>

    <!-- Chat Interface -->
    <div id="chatInterface" class="hidden flex-1 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
      <div class="flex flex-1 overflow-hidden flex-col md:flex-row">
        <!-- Sidebar with users -->
        <div class="sidebar bg-gray-50 p-4 overflow-y-auto">
          <h3 class="font-semibold text-gray-700 mb-4">Psycho Members</h3>
          <ul id="userList">
            <!-- Users will be populated here -->
          </ul>
        </div>
        
        <!-- Main chat area -->
        <div class="main-chat flex-1 flex flex-col">
          <!-- Messages display -->
          <div id="messages" class="message-container flex-1 p-4 overflow-y-auto">
            <!-- Messages will appear here -->
          </div>
          
          <!-- Typing indicator -->
          <div id="typingIndicator" class="typing-indicator px-4 pb-2 hidden"></div>
          
          <!-- Message input -->
          <div class="border-t border-gray-200 p-4">
            <div class="flex">
              <input id="messageInput" type="text" placeholder="Type a message..." 
                     class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              <button id="sendBtn" class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // [Previous Firebase and SoundSystem code remains exactly the same]
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getDatabase, 
      ref, 
      push, 
      onValue, 
      set, 
      remove,
      onDisconnect,
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ==================== RELIABLE SOUND SYSTEM ====================
    const SoundSystem = {
      audioContext: null,
      sounds: {},
      
      init() {
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          this.createSounds();
        } catch (e) {
          console.error("Audio init error:", e);
        }
      },
      
      createSounds() {
        // Send sound (high pitch beep)
        this.sounds.send = this.createBeep(800, 0.1);
        // Receive sound (low pitch beep)
        this.sounds.receive = this.createBeep(400, 0.15);
      },
      
      createBeep(frequency, duration) {
        return () => {
          const osc = this.audioContext.createOscillator();
          const gain = this.audioContext.createGain();
          
          osc.connect(gain);
          gain.connect(this.audioContext.destination);
          
          osc.type = "sine";
          osc.frequency.value = frequency;
          gain.gain.value = 0.3;
          
          const now = this.audioContext.currentTime;
          osc.start(now);
          osc.stop(now + duration);
          gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
        };
      },
      
      play(name) {
        if (this.sounds[name]) {
          try {
            if (this.audioContext.state === 'suspended') {
              this.audioContext.resume();
            }
            this.sounds[name]();
          } catch (e) {
            console.error("Sound play error:", e);
          }
        }
      }
    };
    
    // Initialize on first user interaction
    document.addEventListener('click', () => SoundSystem.init(), { once: true });
    // ==================== END SOUND SYSTEM ====================

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD7KxzDYBJnH90bRxVjVrdy35Gm_ZOGxug",
      authDomain: "psycho-71dc6.firebaseapp.com",
      databaseURL: "https://psycho-71dc6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "psycho-71dc6",
      storageBucket: "psycho-71dc6.firebasestorage.app",
      messagingSenderId: "142521246841",
      appId: "1:142521246841:web:e254082b087a8cb1faa0a8"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // User passwords
    const userPasswords = {
      "Abdullah": "abd123",
      "Noman": "nom456",
      "Prottoy": "pro789",
      "Raisul": "rai012",
      "Yusha": "yus345",
      "Admin": "admin678"
    };

    let currentUser = null;
    let typingTimeout;
    let userStatusRef;
    let isWindowActive = true;
    let lastMessageId = null;

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user was already logged in
      const savedUser = localStorage.getItem('messengerUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        startChatSession();
      }

      // Set up event listeners
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      // Typing indicator
      document.getElementById('messageInput').addEventListener('input', () => {
        if (!currentUser) return;
        
        set(ref(db, `typing/${currentUser.name}`), true);
        
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          set(ref(db, `typing/${currentUser.name}`), false);
        }, 2000);
      });

      // Visibility change listeners
      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('focus', handleWindowFocus);
      window.addEventListener('blur', handleWindowBlur);
    });

    function handleVisibilityChange() {
      document.hidden ? handleWindowBlur() : handleWindowFocus();
    }

    function handleWindowFocus() {
      isWindowActive = true;
      if (currentUser && userStatusRef) set(userStatusRef, true);
    }

    function handleWindowBlur() {
      isWindowActive = false;
      if (currentUser && userStatusRef) set(userStatusRef, false);
    }

    function handleLogin() {
      const userName = document.getElementById('userSelect').value;
      const password = document.getElementById('password').value;
      
      if (!userName) {
        alert('Please select your name');
        return;
      }
      
      if (userPasswords[userName] !== password) {
        alert('Incorrect password');
        return;
      }
      
      currentUser = {
        name: userName,
        isAdmin: userName === 'Admin'
      };
      
      localStorage.setItem('messengerUser', JSON.stringify(currentUser));
      startChatSession();
    }

    function handleLogout() {
      if (currentUser) {
        set(ref(db, `online/${currentUser.name}`), false);
        currentUser = null;
        localStorage.removeItem('messengerUser');
        document.getElementById('chatInterface').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('userInfo').classList.add('hidden');
      }
    }

    function startChatSession() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('chatInterface').classList.remove('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('currentUserName').textContent = currentUser.name;
      
      userStatusRef = ref(db, `online/${currentUser.name}`);
      set(userStatusRef, true);
      onDisconnect(userStatusRef).set(false);
      
      loadUsers();
      loadMessages();
      setupRealtimeListeners();
    }

    function loadUsers() {
      const userList = document.getElementById('userList');
      userList.innerHTML = '';
      
      const users = ["Abdullah", "Noman", "Prottoy", "Raisul", "Yusha", "Admin"];
      
      users.forEach(user => {
        const li = document.createElement('li');
        li.className = 'py-2 flex items-center';
        li.innerHTML = `
          <span class="online-dot offline" id="status-${user}"></span>
          <span>${user}</span>
        `;
        userList.appendChild(li);
        
        onValue(ref(db, `online/${user}`), (snapshot) => {
          const isOnline = snapshot.val();
          document.getElementById(`status-${user}`).className = `online-dot ${isOnline ? 'online' : 'offline'}`;
        });
      });
    }

    function loadMessages() {
      onValue(ref(db, 'messages'), (snapshot) => {
        const messages = snapshot.val() || {};
        displayMessages(messages);
        
        // Play receive sound for new messages from others
        const messageIds = Object.keys(messages);
        const latestMessageId = messageIds[messageIds.length - 1];
        
        if (latestMessageId && latestMessageId !== lastMessageId) {
          const latestMessage = messages[latestMessageId];
          if (latestMessage.sender !== currentUser.name) {
            SoundSystem.play('receive');
          }
          lastMessageId = latestMessageId;
        }
      });
    }

    function displayMessages(messages) {
      const messagesContainer = document.getElementById('messages');
      messagesContainer.innerHTML = '';
      
      Object.entries(messages).forEach(([id, message]) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble ${
          message.sender === currentUser.name ? 'sent' : 'received'
        }`;
        
        messageDiv.innerHTML = `
          <div class="font-semibold">${message.sender}</div>
          <div>${message.text}</div>
          <div class="text-xs mt-1 opacity-70">${formatTime(message.timestamp)}</div>
          ${currentUser.isAdmin ? `<button onclick="deleteMessage('${id}')" class="text-xs text-red-500 mt-1">Delete</button>` : ''}
        `;
        
        messagesContainer.appendChild(messageDiv);
      });
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function setupRealtimeListeners() {
      onValue(ref(db, 'typing'), (snapshot) => {
        const typingStatus = snapshot.val() || {};
        const typingUsers = Object.entries(typingStatus)
          .filter(([user, isTyping]) => isTyping && user !== currentUser.name)
          .map(([user]) => user);
        
        const typingIndicator = document.getElementById('typingIndicator');
        
        if (typingUsers.length > 0) {
          const names = typingUsers.join(' and ');
          typingIndicator.textContent = `${names} ${typingUsers.length > 1 ? 'are' : 'is'} typing...`;
          typingIndicator.classList.remove('hidden');
        } else {
          typingIndicator.classList.add('hidden');
        }
      });
    }

    function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const messageText = messageInput.value.trim();
      
      if (messageText && currentUser) {
        const newMessage = {
          sender: currentUser.name,
          text: messageText,
          timestamp: serverTimestamp()
        };
        
        push(ref(db, 'messages'), newMessage);
        messageInput.value = '';
        
        // Play send sound
        SoundSystem.play('send');
        
        // Clear typing indicator
        set(ref(db, `typing/${currentUser.name}`), false);
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return 'Just now';
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    window.deleteMessage = function(messageId) {
      if (currentUser && currentUser.isAdmin) {
        if (confirm('Are you sure you want to delete this message?')) {
          remove(ref(db, `messages/${messageId}`));
        }
      }
    };
  </script>
</body>
</html>
