<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Psycho Messenger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .online-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .online {
      background-color: #10B981;
    }
    .offline {
      background-color: #EF4444;
    }
    .typing-indicator {
      opacity: 0.6;
      font-size: 0.8rem;
      margin-left: 10px;
      font-style: italic;
    }
    .message-container {
      max-height: 70vh;
      overflow-y: auto;
    }
    .message-bubble {
      max-width: 70%;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
    }
    .sent {
      background-color: #3B82F6;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }
    .received {
      background-color: #E5E7EB;
      color: #111827;
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto max-w-6xl h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">Team Messenger</h1>
        <div id="userInfo" class="hidden">
          <span id="currentUserName" class="font-medium"></span>
          <button id="logoutBtn" class="ml-4 px-3 py-1 bg-white text-blue-600 rounded-md text-sm">Logout</button>
        </div>
      </div>
    </header>

    <!-- Login Form -->
    <div id="loginForm" class="max-w-md mx-auto my-auto bg-white p-8 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Login to Messenger</h2>
      
      <div class="mb-4">
        <label for="userSelect" class="block text-sm font-medium text-gray-700 mb-1">Who are you?</label>
        <select id="userSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          <option value="">Select your name</option>
          <option value="Abdullah">Abdullah</option>
          <option value="Noman">Noman</option>
          <option value="Prottoy">Prottoy</option>
          <option value="Raisul">Raisul</option>
          <option value="Yusha">Yusha</option>
          <option value="Admin">Admin</option>
        </select>
      </div>

      <div class="mb-6">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md"/>
      </div>

      <button id="loginBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Login</button>
    </div>

    <!-- Chat Interface -->
    <div id="chatInterface" class="hidden flex-1 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar with users -->
        <div class="w-1/4 border-r border-gray-200 bg-gray-50 p-4 overflow-y-auto">
          <h3 class="font-semibold text-gray-700 mb-4">Psycho Members</h3>
          <ul id="userList">
            <!-- Users will be populated here -->
          </ul>
        </div>
        
        <!-- Main chat area -->
        <div class="flex-1 flex flex-col">
          <!-- Messages display -->
          <div id="messages" class="message-container flex-1 p-4 overflow-y-auto">
            <!-- Messages will appear here -->
          </div>
          
          <!-- Typing indicator -->
          <div id="typingIndicator" class="typing-indicator px-4 pb-2 hidden"></div>
          
          <!-- Message input -->
          <div class="border-t border-gray-200 p-4">
            <div class="flex">
              <input id="messageInput" type="text" placeholder="Type a message..." 
                     class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              <button id="sendBtn" class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Updated Modular Version) -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getDatabase, 
      ref, 
      push, 
      onValue, 
      set, 
      remove,
      onDisconnect,
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD7KxzDYBJnH90bRxVjVrdy35Gm_ZOGxug",
      authDomain: "psycho-71dc6.firebaseapp.com",
      databaseURL: "https://psycho-71dc6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "psycho-71dc6",
      storageBucket: "psycho-71dc6.firebasestorage.app",
      messagingSenderId: "142521246841",
      appId: "1:142521246841:web:e254082b087a8cb1faa0a8"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Make Firebase methods available globally
    window.firebase = {
      db,
      ref,
      push,
      onValue,
      set,
      remove,
      onDisconnect,
      serverTimestamp
    };

    // User passwords
    const userPasswords = {
      "Abdullah": "abd123",
      "Noman": "nom456",
      "Prottoy": "pro789",
      "Raisul": "rai012",
      "Yusha": "yus345",
      "Admin": "admin678"
    };

    let currentUser = null;
    let typingTimeout;
    let onlineUsers = {};

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user was already logged in
      const savedUser = localStorage.getItem('messengerUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        startChatSession();
      }

      // Set up event listeners
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // Typing indicator
      document.getElementById('messageInput').addEventListener('input', () => {
        if (!currentUser) return;
        
        // Notify others that user is typing
        set(ref(db, `typing/${currentUser.name}`), true);
        
        // Clear previous timeout
        if (typingTimeout) clearTimeout(typingTimeout);
        
        // Set timeout to remove typing indicator after 2 seconds of inactivity
        typingTimeout = setTimeout(() => {
          set(ref(db, `typing/${currentUser.name}`), false);
        }, 2000);
      });
    });

    function handleLogin() {
      const userName = document.getElementById('userSelect').value;
      const password = document.getElementById('password').value;
      
      if (!userName) {
        alert('Please select your name');
        return;
      }
      
      if (userPasswords[userName] !== password) {
        alert('Incorrect password');
        return;
      }
      
      currentUser = {
        name: userName,
        isAdmin: userName === 'Admin'
      };
      
      // Save user to localStorage to keep them logged in
      localStorage.setItem('messengerUser', JSON.stringify(currentUser));
      
      // Start the chat session
      startChatSession();
    }

    function handleLogout() {
      if (currentUser) {
        // Set user offline
        set(ref(db, `online/${currentUser.name}`), false);
        
        // Clear current user
        currentUser = null;
        localStorage.removeItem('messengerUser');
        
        // Hide chat interface and show login form
        document.getElementById('chatInterface').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('userInfo').classList.add('hidden');
      }
    }

    function startChatSession() {
      // Update UI
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('chatInterface').classList.remove('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('currentUserName').textContent = currentUser.name;
      
      // Set user online status
      const userStatusRef = ref(db, `online/${currentUser.name}`);
      set(userStatusRef, true);
      
      // Set up onDisconnect to mark user as offline when they disconnect
      onDisconnect(userStatusRef).set(false);
      
      // Load users and messages
      loadUsers();
      loadMessages();
      
      // Set up listeners for real-time updates
      setupRealtimeListeners();
    }

    function loadUsers() {
      const userList = document.getElementById('userList');
      userList.innerHTML = '';
      
      const users = ["Abdullah", "Noman", "Prottoy", "Raisul", "Yusha", "Admin"];
      
      users.forEach(user => {
        const li = document.createElement('li');
        li.className = 'py-2 flex items-center';
        li.innerHTML = `
          <span class="online-dot offline" id="status-${user}"></span>
          <span>${user}</span>
        `;
        userList.appendChild(li);
        
        // Check initial online status
        onValue(ref(db, `online/${user}`), (snapshot) => {
          const isOnline = snapshot.val();
          updateUserStatus(user, isOnline);
        });
      });
    }

    function updateUserStatus(user, isOnline) {
      const statusDot = document.getElementById(`status-${user}`);
      if (statusDot) {
        statusDot.classList.remove(isOnline ? 'offline' : 'online');
        statusDot.classList.add(isOnline ? 'online' : 'offline');
      }
    }

    function loadMessages() {
      onValue(ref(db, 'messages'), (snapshot) => {
        const messages = snapshot.val() || [];
        displayMessages(messages);
      });
    }

    function displayMessages(messages) {
      const messagesContainer = document.getElementById('messages');
      messagesContainer.innerHTML = '';
      
      Object.entries(messages).forEach(([id, message]) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble ${
          message.sender === currentUser.name ? 'sent' : 'received'
        }`;
        
        messageDiv.innerHTML = `
          <div class="font-semibold">${message.sender}</div>
          <div>${message.text}</div>
          <div class="text-xs mt-1 opacity-70">${formatTime(message.timestamp)}</div>
          ${currentUser.isAdmin ? `<button onclick="deleteMessage('${id}')" class="text-xs text-red-500 mt-1">Delete</button>` : ''}
        `;
        
        messagesContainer.appendChild(messageDiv);
      });
      
      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function setupRealtimeListeners() {
      // Typing indicators
      onValue(ref(db, 'typing'), (snapshot) => {
        const typingStatus = snapshot.val() || {};
        const typingUsers = Object.entries(typingStatus)
          .filter(([user, isTyping]) => isTyping && user !== currentUser.name)
          .map(([user]) => user);
        
        const typingIndicator = document.getElementById('typingIndicator');
        
        if (typingUsers.length > 0) {
          const names = typingUsers.join(' and ');
          typingIndicator.textContent = `${names} ${typingUsers.length > 1 ? 'are' : 'is'} typing...`;
          typingIndicator.classList.remove('hidden');
        } else {
          typingIndicator.classList.add('hidden');
        }
      });
    }

    function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const messageText = messageInput.value.trim();
      
      if (messageText && currentUser) {
        const newMessage = {
          sender: currentUser.name,
          text: messageText,
          timestamp: serverTimestamp()
        };
        
        push(ref(db, 'messages'), newMessage);
        messageInput.value = '';
        
        // Clear typing indicator
        set(ref(db, `typing/${currentUser.name}`), false);
      }
    }

    function deleteMessage(messageId) {
      if (currentUser && currentUser.isAdmin) {
        if (confirm('Are you sure you want to delete this message?')) {
          remove(ref(db, `messages/${messageId}`));
        }
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return 'Just now';
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Make deleteMessage available globally for button clicks
    window.deleteMessage = deleteMessage;
  </script>
</body>
</html>
