<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Psycho Messenger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .online-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .online { background-color: #10B981; }
    .offline { background-color: #EF4444; }
    .typing-indicator {
      opacity: 0.6;
      font-size: 0.8rem;
      margin-left: 10px;
      font-style: italic;
    }
    .message-container {
      max-height: 70vh;
      overflow-y: auto;
    }
    .message-bubble {
      max-width: 70%;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      position: relative;
    }
    .sent {
      background-color: #3B82F6;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }
    .received {
      background-color: #E5E7EB;
      color: #111827;
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
    }
    .active-chat { background-color: #EFF6FF; }
    .delete-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #EF4444;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message-bubble:hover .delete-btn {
      opacity: 1;
    }
    @media (max-width: 768px) {
      .chat-interface { flex-direction: column; }
      .sidebar {
        width: 100% !important;
        border-right: none !important;
        border-bottom: 1px solid #E5E7EB;
        max-height: 150px;
        overflow-y: auto;
      }
      .message-container { max-height: 60vh; }
      .user-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px;
      }
      .delete-btn {
        opacity: 1;
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Audio elements for sounds -->
  <audio id="sendSound" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" preload="auto"></audio>
  <audio id="receiveSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>
  <audio id="typingSound" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-small-sweep-transition-166.mp3" preload="auto"></audio>

  <div class="container mx-auto max-w-6xl h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">Psycho Messenger</h1>
        <div id="userInfo" class="hidden">
          <span id="currentUserName" class="font-medium"></span>
          <button id="logoutBtn" class="ml-4 px-3 py-1 bg-white text-blue-600 rounded-md text-sm">Logout</button>
        </div>
      </div>
    </header>

    <!-- Login Form -->
    <div id="loginForm" class="max-w-md mx-auto my-auto bg-white p-8 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Login to Psycho</h2>
      <div class="mb-4">
        <label for="userSelect" class="block text-sm font-medium text-gray-700 mb-1">Who are you?</label>
        <select id="userSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          <option value="">Select your name</option>
          <option value="Abdullah">Abdullah</option>
          <option value="Noman">Noman</option>
          <option value="Prottoy">Prottoy</option>
          <option value="Raisul">Raisul</option>
          <option value="Yusha">Yusha</option>
          <option value="Admin">Admin</option>
        </select>
      </div>
      <div class="mb-6">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md"/>
      </div>
      <button id="loginBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Login</button>
    </div>

    <!-- Chat Interface -->
    <div id="chatInterface" class="hidden flex-1 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
      <div class="flex flex-1 overflow-hidden chat-interface">
        <!-- Sidebar -->
        <div class="w-1/4 border-r border-gray-200 bg-gray-50 p-4 overflow-y-auto sidebar">
          <h3 class="font-semibold text-gray-700 mb-4">Psycho Members</h3>
          <ul id="userList">
            <li id="groupChat" class="py-2 flex items-center active-chat cursor-pointer">
              <span class="online-dot online"></span>
              <span class="user-name">PsychoGroup</span>
            </li>
          </ul>
        </div>
        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
          <div id="chatHeader" class="border-b border-gray-200 p-4 font-semibold">PsychoGroup</div>
          <div id="messages" class="message-container flex-1 p-4 overflow-y-auto"></div>
          <div id="typingIndicator" class="typing-indicator px-4 pb-2 hidden"></div>
          <div class="border-t border-gray-200 p-4">
            <div class="flex">
              <input id="messageInput" type="text" placeholder="Type a message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              <button id="sendBtn" class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, onDisconnect, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7KxzDYBJnH90bRxVjVrdy35Gm_ZOGxug",
      authDomain: "psycho-71dc6.firebaseapp.com",
      databaseURL: "https://psycho-71dc6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "psycho-71dc6",
      storageBucket: "psycho-71dc6.appspot.com",
      messagingSenderId: "142521246841",
      appId: "1:142521246841:web:e254082b087a8cb1faa0a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const userPasswords = {
      "Abdullah": "abd123",
      "Noman": "nom456",
      "Prottoy": "pro789",
      "Raisul": "rai012",
      "Yusha": "yus345",
      "Admin": "admin678"
    };

    let users = ["Abdullah", "Noman", "Prottoy", "Raisul", "Yusha", "Admin"];
    let currentUser = null;
    let currentChat = 'group';
    let currentChatWith = null;
    let typingTimeout;
    let userStatusRef;
    let lastMessageId = null;
    let currentMessagesRef = null;
    let typingRefs = {};

    // Sound elements
    const sendSound = document.getElementById('sendSound');
    const receiveSound = document.getElementById('receiveSound');
    const typingSound = document.getElementById('typingSound');

    document.addEventListener('DOMContentLoaded', () => {
      const savedUser = localStorage.getItem('messengerUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        startChatSession();
      }
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('messageInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
      document.getElementById('messageInput').addEventListener('input', handleTyping);
      document.getElementById('groupChat').addEventListener('click', () => switchToChat('group'));
    });

    function handleLogin() {
      const userName = document.getElementById('userSelect').value;
      const password = document.getElementById('password').value;
      if (!userName) return alert('Please select your name');
      if (userPasswords[userName] !== password) return alert('Incorrect password');
      currentUser = { name: userName, isAdmin: userName === 'Admin' };
      localStorage.setItem('messengerUser', JSON.stringify(currentUser));
      startChatSession();
    }

    function handleLogout() {
      if (currentUser) {
        set(ref(db, `online/${currentUser.name}`), false);
        // Clear typing status
        if (currentChat === 'group') {
          set(ref(db, `typing/group/${currentUser.name}`), false);
        } else if (currentChatWith) {
          set(ref(db, `typing/private/${currentUser.name}_${currentChatWith}`), false);
        }
        
        currentUser = null;
        localStorage.removeItem('messengerUser');
        document.getElementById('chatInterface').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('userInfo').classList.add('hidden');
      }
    }

    function startChatSession() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('chatInterface').classList.remove('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('currentUserName').textContent = currentUser.name;
      userStatusRef = ref(db, `online/${currentUser.name}`);
      set(userStatusRef, true);
      onDisconnect(userStatusRef).set(false);
      loadUsers();
      loadMessages('group');
      setupTypingListeners();
    }

    function loadUsers() {
      const userList = document.getElementById('userList');
      while (userList.children.length > 1) userList.removeChild(userList.lastChild);
      users.forEach(user => {
        if (user === currentUser.name) return;
        const li = document.createElement('li');
        li.className = 'py-2 flex items-center cursor-pointer';
        li.innerHTML = `<span class="online-dot offline" id="status-${user}"></span><span class="user-name">${user}</span>`;
        li.addEventListener('click', () => switchToChat('private', user));
        userList.appendChild(li);
        onValue(ref(db, `online/${user}`), snap => {
          document.getElementById(`status-${user}`).className = `online-dot ${snap.val() ? 'online' : 'offline'}`;
        });
      });
    }

    function setupTypingListeners() {
      // Group typing listener
      const groupTypingRef = ref(db, 'typing/group');
      onValue(groupTypingRef, (snapshot) => {
        const typingData = snapshot.val() || {};
        const typers = Object.keys(typingData).filter(user => 
          typingData[user] === true && user !== currentUser.name
        );
        
        updateTypingIndicator(typers);
      });

      // Private typing listeners for each user
      users.forEach(user => {
        if (user === currentUser.name) return;
        const privateTypingPath = `typing/private/${getPrivateChatKey(user)}`;
        typingRefs[user] = ref(db, privateTypingPath);
        
        onValue(typingRefs[user], (snapshot) => {
          if (currentChat === 'private' && currentChatWith === user) {
            const isTyping = snapshot.val();
            if (isTyping) {
              document.getElementById('typingIndicator').textContent = `${user} is typing...`;
              document.getElementById('typingIndicator').classList.remove('hidden');
              typingSound.play();
            } else {
              document.getElementById('typingIndicator').classList.add('hidden');
            }
          }
        });
      });
    }

    function updateTypingIndicator(typers) {
      const typingIndicator = document.getElementById('typingIndicator');
      if (currentChat === 'group') {
        if (typers.length > 0) {
          const names = typers.join(', ');
          typingIndicator.textContent = `${names} ${typers.length > 1 ? 'are' : 'is'} typing...`;
          typingIndicator.classList.remove('hidden');
          typingSound.play();
        } else {
          typingIndicator.classList.add('hidden');
        }
      }
    }

    function getPrivateChatKey(withUser) {
      const participants = [currentUser.name, withUser].sort();
      return `${participants[0]}_${participants[1]}`;
    }

    function switchToChat(chatType, withUser = null) {
      document.querySelectorAll('#userList li').forEach(li => li.classList.remove('active-chat'));
      if (chatType === 'group') {
        document.getElementById('groupChat').classList.add('active-chat');
        document.getElementById('chatHeader').textContent = 'PsychoGroup';
      } else {
        document.querySelectorAll('#userList li').forEach(li => {
          if (li.querySelector('.user-name').textContent === withUser) li.classList.add('active-chat');
        });
        document.getElementById('chatHeader').textContent = withUser;
      }
      currentChat = chatType;
      currentChatWith = withUser;
      if (currentMessagesRef) off(currentMessagesRef);
      document.getElementById('typingIndicator').classList.add('hidden');
      loadMessages(chatType, withUser);
    }

    function loadMessages(chatType, withUser = null) {
      const messagesPath = getMessagesPath(chatType, withUser);
      currentMessagesRef = ref(db, messagesPath);
      onValue(currentMessagesRef, snapshot => {
        const messages = snapshot.val() || {};
        displayMessages(messages);
        const ids = Object.keys(messages);
        const latestId = ids[ids.length - 1];
        
        // Play receive sound if new message comes from another user
        if (latestId && latestId !== lastMessageId) {
          const latestMessage = messages[latestId];
          if (latestMessage.sender !== currentUser.name) {
            receiveSound.currentTime = 0;
            receiveSound.play();
          }
          lastMessageId = latestId;
        }
      });
    }

    function getMessagesPath(chatType, withUser) {
      if (chatType === 'group') return 'messages/group';
      const participants = [currentUser.name, withUser].sort();
      return `messages/private/${participants[0]}_${participants[1]}`;
    }

    function displayMessages(messages) {
      const c = document.getElementById('messages');
      c.innerHTML = '';
      Object.entries(messages).forEach(([id, msg]) => {
        const div = document.createElement('div');
        div.className = `message-bubble ${msg.sender === currentUser.name ? 'sent' : 'received'}`;
        
        // Add delete button if admin or message owner
        let deleteBtn = '';
        if (currentUser.isAdmin || msg.sender === currentUser.name) {
          deleteBtn = `<span class="delete-btn" data-message-id="${id}">Ã—</span>`;
        }
        
        div.innerHTML = `
          ${deleteBtn}
          <div class="font-semibold">${msg.sender}</div>
          <div>${msg.text}</div>
          <div class="text-xs mt-1 opacity-70">${formatTime(msg.timestamp)}</div>
        `;
        c.appendChild(div);
        
        // Add click event to delete button if it exists
        const deleteButton = div.querySelector('.delete-btn');
        if (deleteButton) {
          deleteButton.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteMessage(id);
          });
        }
      });
      c.scrollTop = c.scrollHeight;
    }

    function deleteMessage(messageId) {
      if (!currentUser) return;
      
      if (!currentUser.isAdmin && !confirm('Are you sure you want to delete this message?')) {
        return;
      }
      
      const path = getMessagesPath(currentChat, currentChatWith);
      remove(ref(db, `${path}/${messageId}`));
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;
      
      const newMessage = {
        sender: currentUser.name,
        text,
        timestamp: Date.now(),
        chatType: currentChat
      };
      
      const path = getMessagesPath(currentChat, currentChatWith);
      push(ref(db, path), newMessage);
      
      // Play send sound
      sendSound.currentTime = 0;
      sendSound.play();
      
      // Clear input and typing status
      input.value = '';
      clearTypingStatus();
    }

    function handleTyping() {
      if (!currentUser) return;
      
      const typingPath = currentChat === 'group' ? 
        `typing/group/${currentUser.name}` : 
        `typing/private/${getPrivateChatKey(currentChatWith)}`;
      
      set(ref(db, typingPath), true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => clearTypingStatus(), 2000);
    }

    function clearTypingStatus() {
      if (!currentUser) return;
      
      const typingPath = currentChat === 'group' ? 
        `typing/group/${currentUser.name}` : 
        `typing/private/${getPrivateChatKey(currentChatWith)}`;
      
      set(ref(db, typingPath), false);
    }

    function formatTime(ts) {
      if (!ts) return 'Just now';
      return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
  </script>
</body>
</html>
